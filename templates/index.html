<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å³æ™‚ç‰©ä»¶è¾¨è­˜ï¼ˆæ‰‹æ©Ÿç›¸æ©Ÿç‰ˆï¼‰</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .video-container {
      position: relative;
      text-align: center;
      margin-bottom: 20px;
    }
    
    video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background: #000;
    }
    
    canvas {
      display: none;
    }
    
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    
    button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 25px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .result-container {
      margin-top: 20px;
    }
    
    .result-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    .result-content {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .object-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      width: 40%;
      display: inline-block;
    }
    
    .object-label {
      font-weight: bold;
      color: #007bff;
      font-size: 16px;
    }
    
    .object-confidence {
      color: #28a745;
      margin-left: 10px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="video-container">
      <video id="video" autoplay playsinline muted></video>
    </div>
    
    <div class="controls">
      <button id="captureBtn" onclick="captureAndSend()" disabled>
        ğŸ“¸ æ‹ç…§ä¸¦è¾¨è­˜
      </button>
      <button onclick="toggleCamera()">ğŸ”„ åˆ‡æ›ç›¸æ©Ÿ</button>
      <button onclick="dummyImage()">Dummy Image</button>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <div class="result-container">
      <div id="result" class="result-content">ç­‰å¾…è¾¨è­˜çµæœ...</div>
    </div>
  </div>

  <script>
    let socket;
    let currentStream = null;
    let isProcessing = false;
    let facingMode = 'environment'; // 'user' ç‚ºå‰é¡é ­ï¼Œ'environment' ç‚ºå¾Œé¡é ­
    
    // åˆå§‹åŒ– Socket é€£ç·š
    function initSocket() {
      // è‡ªå‹•åµæ¸¬å”è­°ï¼ˆHTTP æˆ– HTTPSï¼‰
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const socketUrl = `${window.location.protocol}//${window.location.host}`;
      
      socket = io(socketUrl, {
        transports: ['websocket', 'polling'],
        upgrade: true,
        rememberUpgrade: true
      });
      
      socket.on('connect', () => {
        console.log("å·²é€£ç·š WebSocket");
        showStatus("âœ… å·²æˆåŠŸé€£æ¥åˆ°ä¼ºæœå™¨", 'connected');
        document.getElementById('captureBtn').disabled = false;
      });
      
      socket.on('disconnect', () => {
        console.log("WebSocket æ–·ç·š");
        showStatus("âŒ èˆ‡ä¼ºæœå™¨é€£ç·šä¸­æ–·", 'error');
        document.getElementById('captureBtn').disabled = true;
      });
      
      socket.on('status', data => {
        console.log("ä¼ºæœå™¨ç‹€æ…‹:", data.message);
      });
      
      socket.on('result', data => {
        console.log("æ”¶åˆ°è¾¨è­˜çµæœ:", data);
        displayResults(data);
        setProcessing(false);
      });
      
      socket.on('error', err => {
        console.error("Socket éŒ¯èª¤:", err);
        document.getElementById('result').innerHTML = `<span style="color: red;">âŒ éŒ¯èª¤: ${err.error}</span>`;
        setProcessing(false);
      });
    }
    
    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      
      // 3ç§’å¾Œè‡ªå‹•éš±è—æˆåŠŸè¨Šæ¯
      if (type === 'connected') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      }
    }
    
    // è¨­ç½®è™•ç†ç‹€æ…‹
    function setProcessing(processing) {
      isProcessing = processing;
      const btn = document.getElementById('captureBtn');
      
      if (processing) {
        btn.disabled = true;
        btn.innerHTML = 'ğŸ”„ è™•ç†ä¸­... <span id="loading" class="loading"></span>';
      } else {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¸ æ‹ç…§ä¸¦è¾¨è­˜';
      }
    }
    
    // å•Ÿç”¨ç›¸æ©Ÿ
    async function startCamera() {
      try {
        // åœæ­¢ç¾æœ‰ä¸²æµ
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const constraints = {
          video: {
            facingMode: facingMode,
            width: { ideal: 224 },
            height: { ideal: 224 }
          }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('video');
        video.srcObject = stream;
        currentStream = stream;
        
        console.log("ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ");
        
      } catch (err) {
        console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:", err);
        showStatus(`âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: ${err.message}`, 'error');
        
        // å¦‚æœå¾Œé¡é ­å¤±æ•—ï¼Œå˜—è©¦å‰é¡é ­
        if (facingMode === 'environment') {
          facingMode = 'user';
          startCamera();
        }
      }
    }
    
    // åˆ‡æ›å‰å¾Œé¡é ­
    function toggleCamera() {
      facingMode = facingMode === 'user' ? 'environment' : 'user';
      startCamera();
    }

    function dummyImage() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width = 224;
      canvas.height = 224;
      const context = canvas.getContext('2d');
      const img = new Image();
      img.src = '/static/images/dummy.jpg';
      img.onload = function() {
        context.drawImage(img, 0, 0, canvas.width, canvas.height);
        // è½‰æ›ç‚º base64ï¼Œé™ä½å“è³ªä»¥åŠ å¿«å‚³è¼¸
        const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

        if (!base64Data) {
          showStatus("âŒ ç„¡æ³•æ“·å–å½±åƒ", 'error');
          return;
        }

        // âœ… base64Data å¯é€å‡ºæˆ–è™•ç†
        console.log(base64Data);
        setProcessing(true);
        document.getElementById('result').textContent = "ğŸ”„ æ­£åœ¨åˆ†æå½±åƒ...";
        
        // æª¢æŸ¥ socket é€£ç·šç‹€æ…‹
        if (!socket || !socket.connected) {
          showStatus("âŒ èˆ‡ä¼ºæœå™¨é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢", 'error');
          setProcessing(false);
          return;
        }
        
        // å‚³é€å½±åƒåˆ°ä¼ºæœå™¨
        socket.emit('image', { image_base64: base64Data });
      };
    }
    
    // æ‹ç…§ä¸¦å‚³é€
    function captureAndSend() {
      if (isProcessing) {
        console.log('æ­£åœ¨è™•ç†ä¸­ï¼Œå¿½ç•¥é‡è¤‡è«‹æ±‚');
        return;
      }
      
      try {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        
        if (!video || !canvas) {
          showStatus("âŒ é é¢å…ƒç´ è¼‰å…¥éŒ¯èª¤", 'error');
          return;
        }
        
        const context = canvas.getContext('2d');
        
        // æª¢æŸ¥å½±ç‰‡æ˜¯å¦æº–å‚™å¥½
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          showStatus("âŒ ç›¸æ©Ÿå°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦", 'error');
          return;
        } else {
          
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // è½‰æ›ç‚º base64ï¼Œé™ä½å“è³ªä»¥åŠ å¿«å‚³è¼¸
        const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

        if (!base64Data) {
          showStatus("âŒ ç„¡æ³•æ“·å–å½±åƒ", 'error');
          return;
        }

        // âœ… base64Data å¯é€å‡ºæˆ–è™•ç†
        console.log(base64Data);
        setProcessing(true);
        document.getElementById('result').textContent = "ğŸ”„ æ­£åœ¨åˆ†æå½±åƒ...";
        
        // æª¢æŸ¥ socket é€£ç·šç‹€æ…‹
        if (!socket || !socket.connected) {
          showStatus("âŒ èˆ‡ä¼ºæœå™¨é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢", 'error');
          setProcessing(false);
          return;
        }
        
        // å‚³é€å½±åƒåˆ°ä¼ºæœå™¨
        socket.emit('image', { image_base64: base64Data });
      } catch (err) {
        console.error("æ‹ç…§å¤±æ•—:", err);
        showStatus(`âŒ æ‹ç…§å¤±æ•—: ${err.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        setProcessing(false);
      }
    }
    
    // é¡¯ç¤ºè¾¨è­˜çµæœ
    function displayResults(data) {
      const resultEl = document.getElementById('result');
      
      if (!data.objects || data.objects.length === 0) {
        resultEl.innerHTML = "ğŸ¤·â€â™‚ï¸ æœªæª¢æ¸¬åˆ°ä»»ä½•ç‰©ä»¶";
        return;
      }
      
      let html = `<div style="margin-bottom: 10px;">
        <strong>ğŸ“Š æª¢æ¸¬åˆ° ${data.objects.length} å€‹ç‰©ä»¶ï¼š</strong>
      </div>`;
      
      data.objects.forEach((obj, index) => {
        const confidence = Math.round(obj.confidence * 100);
        html += `
          <div class="object-item">
            <span class="object-label">${obj.label}</span>
            <span class="object-confidence">${confidence}%</span>
            <div style="margin-top: 5px; font-size: 12px; color: #666;">
              ä½ç½®: [${obj.bbox.join(', ')}]
            </div>
          </div>
        `;
      });
      
      if (data.image_size) {
        html += `<div style="margin-top: 15px; font-size: 12px; color: #888;">
          å½±åƒå°ºå¯¸: ${data.image_size.width} Ã— ${data.image_size.height}
        </div>`;
      }
      
      resultEl.innerHTML = html;
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initSocket();
      startCamera();
    });
    
    // é é¢é—œé–‰æ™‚æ¸…ç†è³‡æº
    window.addEventListener('beforeunload', () => {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>
</html>